<!DOCTYPE html>
<html>

<head>
  <meta name="referrer" content="no-referrer-when-downgrade">
  <title>Chained</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <style>
    #loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #303030;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      opacity: 1;
      transition: opacity 1s ease-out;
    }

    #loading-screen.fade-out {
      opacity: 0;
    }

    @font-face {
      font-family: "Press Start 2P";
      src: url("https://storage.wildwest.gg/uploads/1730265476288_press_start_2p.woff2") format("woff2");
      font-weight: normal;
      font-style: normal;
    }

    :root {
      --bg-color: #0a0a0a;
      --text-color: #ffffff;
      --primary-color: #ff3333;
      --secondary-color: #1a1a1a;
    }

    /* Add transition for smooth color changes */
    * {
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
    }

    body {
      font-family: Arial, sans-serif;
      background: var(--bg-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      color: var(--text-color);
      position: relative;
      overflow: hidden;
      transition: background-color 0.3s ease, color 0.3s ease;
      height: 100vh;
      margin: 0;
    }

    html {
      overflow: hidden;
    }

    body.light-mode {
      --bg-color: #f0f0f0;
      --text-color: #333333;
      --secondary-color: #ffffff;
      --star-color: #000000;
    }

    body.light-mode[data-main-color="#ff3333"] {
      --primary-color: #ff3333;
    }

    body.light-mode[data-main-color="#3333ff"] {
      --primary-color: #3333ff;
    }

    body.light-mode[data-main-color="#33ff33"] {
      --primary-color: #33ff33;
    }

    body.light-mode[data-main-color="#ff33ff"] {
      --primary-color: #ff33ff;
    }

    #game-container {
      background: var(--secondary-color);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 0 10px var(--primary-color);
      text-align: center;
      max-width: 600px;
      width: 100%;
      position: relative;
      z-index: 1;
      max-height: calc(100vh - 40px);
      overflow-y: scroll;
      scrollbar-width: none;
      /* Firefox */
      -ms-overflow-style: none;
      /* Internet Explorer 10+ */
    }

    #game-container::-webkit-scrollbar {
      width: 0;
      height: 0;
    }

    #stars-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }

    .star {
      position: absolute;
      background-color: var(--primary-color);
      border-radius: 50%;
      animation: twinkle 5s infinite, move 20s linear infinite;
      transition: background-color 0.3s ease;
    }

    @keyframes twinkle {
      0% {
        opacity: 0;
      }

      50% {
        opacity: 1;
      }

      100% {
        opacity: 0;
      }
    }

    @keyframes move {
      0% {
        transform: translateY(0);
      }

      100% {
        transform: translateY(100vh);
      }
    }

    .word-chain {
      margin: 20px 0;
      min-height: 50px;
      font-size: 1.2em;
      color: var(--text-color);
      transition: color 0.3s ease;
    }

    .current-word {
      color: var(--primary-color);
      font-weight: bold;
      margin: 10px 0;
      transition: color 0.3s ease;
    }

    input {
      padding: 10px;
      font-size: 16px;
      margin: 10px 0;
      width: 200px;
      font-family: inherit;
      background: var(--secondary-color);
      color: var(--text-color);
      border: 1px solid var(--primary-color);
      outline: none;
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }

    button {
      background: var(--primary-color);
      color: var(--text-color);
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      margin: 10px;
      font-family: inherit;
      border-radius: 8px;
      outline: none;
      transition: background-color 0.3s ease, color 0.3s ease, opacity 0.3s ease;
    }

    button:hover {
      opacity: 0.8;
    }

    #timer {
      font-size: 1.2em;
      color: var(--primary-color);
      margin: 10px 0;
      transition: color 0.3s ease;
    }

    .score {
      font-size: 1.2em;
      color: var(--text-color);
      margin: 20px 0;
      transition: color 0.3s ease;
    }

    .error {
      color: var(--primary-color);
      min-height: 20px;
      margin: 10px 0;
      transition: color 0.3s ease;
    }

    .rules {
      font-size: 0.8em;
      margin: 20px 0;
      line-height: 1.5;
      text-align: left;
      color: var(--text-color);
      transition: color 0.3s ease;
    }

    #leaderboard {
      margin-top: 20px;
      text-align: left;
      background: var(--secondary-color);
      padding: 15px;
      border-radius: 10px;
      transition: background-color 0.3s ease;
    }

    #leaderboard h2 {
      text-align: center;
      color: var(--primary-color);
      transition: color 0.3s ease;
    }

    #leaderboard ol {
      padding-left: 20px;
      color: var(--text-color);
      transition: color 0.3s ease;
    }

    #leaderboard li {
      margin-bottom: 5px;
    }

    #alert-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    #alert-box {
      background-color: var(--secondary-color);
      border: 2px solid var(--primary-color);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      max-width: 80%;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    #alert-message {
      color: var(--text-color);
      margin-bottom: 20px;
      transition: color 0.3s ease;
    }

    #alert-close {
      background-color: var(--primary-color);
      color: var(--text-color);
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 5px;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    #milestone-popup {
      position: fixed;
      top: -100px;
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--primary-color);
      color: var(--text-color);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      font-size: 1.2em;
      font-weight: bold;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: top 0.5s ease-out, opacity 0.5s ease-out, background-color 0.3s ease, color 0.3s ease;
      opacity: 0;
      z-index: 2000;
    }

    #milestone-popup.show {
      top: 20px;
      opacity: 1;
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
      }

      to {
        opacity: 0;
      }
    }

    .fade-out {
      animation: fadeOut 2s ease-out forwards;
    }

    #milestone-3d-animation {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      perspective: 1000px;
      z-index: 2001;
      pointer-events: none;
    }

    .word-3d {
      position: absolute;
      font-size: 3em;
      font-weight: bold;
      color: var(--primary-color);
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      opacity: 0;
      transform-style: preserve-3d;
    }

    @keyframes wordEnter {
      0% {
        opacity: 0;
        transform: translateZ(-1000px) rotateY(0deg);
      }

      50% {
        opacity: 1;
        transform: translateZ(0) rotateY(180deg);
      }

      100% {
        opacity: 1;
        transform: translateZ(0) rotateY(360deg);
      }
    }

    @keyframes wordCollide {
      0% {
        opacity: 1;
        transform: translateX(-50px) rotateY(360deg);
      }

      50% {
        opacity: 1;
        transform: translateX(0) rotateY(540deg) scale(1.2);
      }

      100% {
        opacity: 1;
        transform: translateX(50px) rotateY(720deg) scale(1);
      }
    }

    @keyframes wordFadeOut {
      0% {
        opacity: 1;
        transform: translateZ(0) scale(1);
      }

      100% {
        opacity: 0;
        transform: translateZ(-500px) scale(0);
      }
    }

    #settings-button {
      position: fixed;
      top: 10px;
      right: 10px;
      background: var(--primary-color);
      color: var(--text-color);
      border: none;
      padding: 10px;
      cursor: pointer;
      border-radius: 50%;
      font-size: 20px;
      z-index: 1001;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    #settings-menu {
      position: fixed;
      top: 0;
      right: -300px;
      width: 250px;
      height: 100%;
      background: var(--secondary-color);
      padding: 20px;
      box-shadow: -5px 0 15px rgba(0, 0, 0, 0.3);
      z-index: 1001;
      transition: right 0.3s ease, background-color 0.3s ease;
      overflow-y: auto;
      max-height: 100vh;
    }

    #settings-menu.open {
      right: 0;
    }

    #settings-menu h3 {
      margin-top: 20px;
      color: var(--text-color);
      transition: color 0.3s ease;
    }

    #close-settings {
      background: var(--primary-color);
      color: var(--text-color);
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      margin: 10px;
      font-family: inherit;
      border-radius: 8px;
      outline: none;
      transition: background-color 0.3s ease, color 0.3s ease;
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 16px;
    }

    #close-settings:hover {
      opacity: 0.8;
    }

    #settings-menu label {
      display: block;
      margin-bottom: 10px;
      color: var(--text-color);
      transition: color 0.3s ease;
      font-family: "Press Start 2P", Arial, sans-serif;
    }

    .dropdown {
      position: relative;
      display: inline-block;
      width: 200px;
      margin-bottom: 15px;
    }

    .volume-control {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .volume-control label {
      display: block;
      margin-bottom: 10px;
      font-family: Arial, sans-serif;
      font-size: 1.2em;
    }

    .volume-slider-container {
      display: flex;
      align-items: center;
      width: 100%;
    }

    #volume-slider {
      -webkit-appearance: none;
      width: calc(100% - 60px);
      height: 15px;
      border-radius: 5px;
      background: var(--secondary-color);
      outline: none;
      opacity: 1;
      -webkit-transition: .2s;
      transition: opacity .2s;
      margin-bottom: 10px;
      position: relative;
    }

    #volume-slider:hover {
      opacity: 0.7;
    }

    #volume-slider::-webkit-slider-runnable-track {
      width: 100%;
      height: 15px;
      cursor: pointer;
      background: transparent;
      border-radius: 5px;
    }

    #volume-slider::-moz-range-track {
      width: 100%;
      height: 15px;
      cursor: pointer;
      background: transparent;
      border-radius: 5px;
    }

    #volume-slider::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: var(--volume-percentage, 0%);
      height: 100%;
      background: var(--primary-color);
      border-radius: 5px;
      pointer-events: none;
    }

    #volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 0;
      height: 0;
      background: transparent;
      cursor: pointer;
    }

    #volume-slider::-moz-range-thumb {
      width: 0;
      height: 0;
      border: none;
      background: transparent;
      cursor: pointer;
    }

    #volume-value {
      display: inline-block;
      width: 60px;
      text-align: right;
      font-family: Arial, sans-serif;
      font-size: 1em;
      margin-left: 10px;
      font-weight: bold;
    }

    .dropbtn {
      background-color: var(--primary-color);
      color: var(--text-color);
      padding: 10px;
      font-size: 16px;
      border: none;
      cursor: pointer;
      width: 100%;
      text-align: left;
      border-radius: 5px;
      transition: background-color 0.3s ease, color 0.3s ease, border-radius 0.3s ease;
    }

    .dropdown-content {
      display: block;
      position: absolute;
      background-color: var(--secondary-color);
      min-width: 100%;
      box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
      z-index: 1;
      border-radius: 0 0 5px 5px;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
      opacity: 0;
      left: 0;
    }

    .dropdown-content button {
      color: var(--text-color);
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      border: 1px solid var(--primary-color);
      border-top: none;
      transition: background-color 0.3s ease, opacity 0.3s ease;
      width: 90%;
      text-align: left;
      background: none;
      cursor: pointer;
      box-sizing: border-box;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .dropdown-content button:first-child {
      border-top: 1px solid var(--primary-color);
    }

    .dropdown-content.show {
      max-height: 300px;
      opacity: 1;
    }

    .dropdown-content button:hover {
      background-color: var(--primary-color);
      opacity: 0.8;
    }

    .dropbtn {
      width: 100%;
      border: 1px solid var(--primary-color);
      border-radius: 5px;
      box-sizing: border-box;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .dropdown-content.show+.dropbtn {
      border-radius: 5px 5px 0 0;
    }

    #settings-button {
      background: var(--primary-color);
      color: var(--text-color);
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      margin: 10px;
      font-family: inherit;
      border-radius: 8px;
      outline: none;
      transition: background-color 0.3s ease, color 0.3s ease;
      position: fixed;
      top: 10px;
      right: 10px;
      font-size: 16px;
      z-index: 1001;
    }

    #settings-button:hover {
      opacity: 0.8;
    }

    #discord-button {
      position: fixed;
      top: 10px;
      left: 10px;
      background: transparent;
      color: var(--primary-color);
      border: none;
      padding: 10px;
      cursor: pointer;
      font-size: 24px;
      z-index: 1001;
      transition: color 0.3s ease, opacity 0.3s ease;
    }

    #discord-button:hover {
      opacity: 0.8;
    }
  </style>
  <style>
    #announcement-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background-color: var(--primary-color);
      color: var(--text-color);
      text-align: center;
      padding: 10px;
      z-index: 1000;
      font-weight: bold;
      display: none;
    }

    #settings-button,
    #discord-button {
      transition: top 0.3s ease;
    }

    body.has-announcement #settings-button,
    body.has-announcement #discord-button {
      top: 50px;
    }
  </style>
</head>

<body>
  <div id="announcement-bar"></div>
  <div id="loading-screen"></div>
  <div id="stars-container"></div>
  <div id="game-container">
    <h1>Word Chain</h1>
    <button id="showRulesButton">Show Rules</button>

    <div id="gameplay-elements" style="display: none;">
      <div class="word-chain" id="wordChain"></div>
      <div class="current-word" id="currentWord"></div>
      <form id="wordForm" onsubmit="return false;">
        <input type="text" id="wordInput" placeholder="Enter next word" autocomplete="off">
        <button id="submitButton">Submit</button>
      </form>
      <div class="error" id="error"></div>
      <div class="score">Words: <span id="wordCount">0</span></div>
      <div id="timer">Time left: <span id="timeLeft">10</span>s</div>
      <div id="milestone"></div>
      <div id="highestScore">Highest Score: 0</div>
    </div>
    <button id="newGameButton">New Game</button>
  </div>
  <div id="alert-overlay" style="display: none;">
    <div id="alert-box">
      <p id="alert-message"></p>
      <button id="alert-close">OK</button>
    </div>
  </div>
  <div id="milestone-popup"></div>
  <audio id="milestone-sound">
    <source src="https://iil.pages.dev/a/crct.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  <audio id="correct-sound">
    <source src="https://iil.pages.dev/a/crct.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  <audio id="lose-sound">
    <source src="https://iil.pages.dev/a/lose.wav" type="audio/wav">
    Your browser does not support the audio element.
  </audio>
  <audio id="invalid-sound">
    <source src="https://iil.pages.dev/a/inv.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  <audio id="background-music" loop="">
    <source src="https://iil.pages.dev/a/bg.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  <button id="settings-button">Settings</button>
  <a href="https://discord.gg/Vb8Cfs6FU2" target="_blank" id="discord-button">
    <i class="fab fa-discord"></i>
  </a>
  <div id="settings-menu">
    <button id="close-settings">Close</button>
    <h3>Settings</h3>
    <div class="dropdown">
      <button class="dropbtn">Theme</button>
      <div class="dropdown-content">
        <button onclick="toggleTheme('dark')">Dark Mode</button>
        <button onclick="toggleTheme('light')">Light Mode</button>
      </div>
    </div>
    <div class="dropdown">
      <button class="dropbtn">Main Color</button>
      <div class="dropdown-content">
        <button onclick="changeMainColor('#ff3333')">Red</button>
        <button onclick="changeMainColor('#3333ff')">Blue</button>
        <button onclick="changeMainColor('#33ff33')">Green</button>
        <button onclick="changeMainColor('#ff33ff')">Purple</button>
      </div>
    </div>
    <div class="volume-control">
      <label for="volume-slider" style="font-family:Arial, sans-serif; font-size:1.5em; font-weight: bold;">Volume:</label>
      <div class="volume-slider-container">
        <input type="range" id="volume-slider" min="0" max="100" value="30">
        <span id="volume-value">30%</span>
      </div>
    </div>
    <button id="changeApiKeyButton" style="margin-top: 20px; background-color: var(--primary-color); color: var(--text-color); border: none; padding: 10px; cursor: pointer; border-radius: 5px;">Change API Key</button>
  </div>
  <script>
    (function() {
      // Function to hide loading screen
      function hideLoadingScreen() {
        if (window.top.location.href.includes("g.wildwest.gg")) {
          const announcementBar = document.getElementById('announcement-bar');
          if (announcementBar.style.display === 'block') {
            document.body.style.marginTop = announcementBar.offsetHeight + 'px';
          }
          const loadingScreen = document.getElementById('loading-screen');
          loadingScreen.classList.add('fade-out');
          setTimeout(() => {
            loadingScreen.style.display = 'none';
          }, 1);
        }
      }
      const gdata = {
        startingWords: ['cell', 'home', 'book', 'game', 'food', 'time', 'work', 'life', 'world', 'water', 'air', 'fire', 'earth', 'sun', 'moon', 'star', 'cloud', 'tree', 'flower', 'bird', 'fish', 'dog', 'cat', 'mouse', 'horse', 'car', 'road', 'house', 'school', 'office', 'music', 'art', 'science', 'health', 'love', 'family', 'friend', 'money', 'business', 'technology'], // possible starting words
        pointsPerWord: 10, // points awarded for each valid word
        milestoneIntervals: [5, 10, 25, 50, 100], // number of words to reach each milestone
        premise: "You are an AI that validates whether two words form a valid and meaningful two-word phrase. Respond with only 'true' if they do, or 'false' if they don't. For example, 'cell phone' would be true, but 'cell banana' would be false. response false to anything including profanity ,racism etc, the combination is : ", // premise for AI validation
        maxInvalidAttempts: 3, // maximum number of invalid attempts before game over
        timeLimit: 60, // time limit for each word in seconds
        defaultTheme: 'dark', // default theme
        defaultColor: '#ff3333' // default main color
      };
      let gameState = {
        currentWord: '',
        chain: [],
        chat: [],
        lastSubmitTime: 0,
        invalidAttempts: 0,
        timeLeft: gdata.timeLimit,
        isFirstWord: true,
        highestScore: 0
      };
      let timer;
      let db;
      // Initialize IndexedDB
      function initDB() {
        const request = indexedDB.open('chainedIndexed', 1);
        request.onerror = (event) => {
          console.error("IndexedDB error:", event.target.error);
        };
        request.onsuccess = (event) => {
          db = event.target.result;
          loadGame();
        };
        request.onupgradeneeded = (event) => {
          db = event.target.result;
          const objectStore = db.createObjectStore('gameState', {
            keyPath: 'id'
          });
        };
      }
      // Function to start a new game
      function newGame() {
        gameState.currentWord = gdata.startingWords[
          Math.floor(Math.random() * gdata.startingWords.length)
        ];
        gameState.chain = [gameState.currentWord];
        gameState.chat = [];
        gameState.lastSubmitTime = 0;
        gameState.invalidAttempts = 0;
        gameState.timeLeft = gdata.timeLimit;
        gameState.isFirstWord = true;
        document.getElementById('gameplay-elements').style.display = 'block';
        updateDisplay();
        document.getElementById('timer').style.display = 'none';
        clearInterval(timer);
        saveGame();
      }
      // Function to save the game
      function saveGame() {
        const transaction = db.transaction(['gameState'], 'readwrite');
        const objectStore = transaction.objectStore('gameState');
        const request = objectStore.put({
          id: 1,
          ...gameState
        });
        request.onerror = (event) => {
          console.error("Error saving game:", event.target.error);
        };
      }
      // Function to load the game
      function loadGame() {
        const transaction = db.transaction(['gameState'], 'readonly');
        const objectStore = transaction.objectStore('gameState');
        const request = objectStore.get(1);
        request.onerror = (event) => {
          console.error("Error loading game:", event.target.error);
        };
        request.onsuccess = (event) => {
          if (request.result) {
            gameState = request.result;
            updateDisplay();
          }
        };
      }
      // Function to start the timer for each word
      function startTimer() {
        clearInterval(timer);
        gameState.timeLeft = gdata.timeLimit;
        updateTimerDisplay();
        document.getElementById('timer').style.display = 'block';
        timer = setInterval(() => {
          gameState.timeLeft--;
          updateTimerDisplay();
          if (gameState.timeLeft <= 0) {
            clearInterval(timer);
            handleTimeUp();
          }
        }, 1000);
      }
      // Function to show milestone alert
      function showMilestoneAlert(message) {
        const milestonePopup = document.getElementById('milestone-popup');
        milestonePopup.textContent = message;
        milestonePopup.classList.add('show');
        setTimeout(() => {
          milestonePopup.classList.add('fade-out');
          setTimeout(() => {
            milestonePopup.classList.remove('show', 'fade-out');
            startTimer();
          }, 2000);
        }, 3000);
      }
      // Function to show 3D animation
      function show3DAnimation(word1, word2) {
        const animationContainer = document.createElement('div');
        animationContainer.id = 'milestone-3d-animation';
        document.body.appendChild(animationContainer);
        const word1Element = document.createElement('div');
        word1Element.className = 'word-3d';
        word1Element.textContent = word2;
        word1Element.style.left = '0';
        animationContainer.appendChild(word1Element);
        const word2Element = document.createElement('div');
        word2Element.className = 'word-3d';
        word2Element.textContent = word1;
        word2Element.style.right = '0';
        animationContainer.appendChild(word2Element);
        // Animate words entering
        word1Element.style.animation = 'wordEnter 1s forwards';
        word2Element.style.animation = 'wordEnter 1s forwards 0.5s';
        // Animate words colliding
        setTimeout(() => {
          word1Element.style.animation = 'wordCollide 1s forwards';
          word2Element.style.animation = 'wordCollide 1s forwards';
        }, 1000);
        // Animate words fading out
        setTimeout(() => {
          word1Element.style.animation = 'wordFadeOut 1s forwards';
          word2Element.style.animation = 'wordFadeOut 1s forwards';
        }, 2000);
        // Remove animation container
        setTimeout(() => {
          document.body.removeChild(animationContainer);
        }, 3000);
      }
      // Function to update the timer display
      function updateTimerDisplay() {
        document.getElementById('timeLeft').textContent = gameState.timeLeft;
      }
      // Function to handle when time is up
      function handleTimeUp() {
        clearInterval(timer);
        generateValidWord(gameState.currentWord).then(validWord => {
          playLoseSound();
          showAlert(`Out of time! Your final chain has ${gameState.chain.length} words. A valid word would have been: "${validWord}"`);
          saveGame();
        });
      }
      // Function to submit a word
      let isSubmitting = false;

      function submitWord() {
        if (isSubmitting) return;
        isSubmitting = true;
        const currentTime = Date.now();
        const input = document.getElementById('wordInput').value.toLowerCase().trim();
        const error = document.getElementById('error');
        if (!input) {
          error.textContent = 'Please enter a word';
          isSubmitting = false;
          return;
        }
        if (!/^[a-z]+$/.test(input)) {
          error.textContent = 'Please use only alphabetical characters';
          gameState.invalidAttempts++;
          document.getElementById('wordInput').value = '';
          playInvalidSound();
          checkGameOver();
          isSubmitting = false;
          return;
        }
        gameState.lastSubmitTime = currentTime;
        validateWordWithAI(gameState.currentWord, input);
      }
      // Function to validate word with AI
      async function validateWordWithAI(word1, word2) {
        const premise = gdata.premise;
        if (/\d/.test(word2) || ['one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine', 'ten'].includes(word2)) {
          handleValidationResult(false, word2);
          return;
        }
        if (['up', 'down', 'left', 'right'].includes(word2)) {
          handleValidationResult(true, word2);
          return;
        }
        gameState.chat.push(`${word1} ${word2}`);
        try {
          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${localStorage.getItem('geminiApiKey')}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                contents: [{
                  parts: [{
                    text: `${premise}\n\n${word1} ${word2}`
                  }]
                }]
              })
            }
          );
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          const data = await response.json();
          const candidateText = data?.candidates?.[0]?.content?.parts?.[0]?.text;
          const isValid = candidateText && candidateText.toLowerCase().trim() === 'true';
          handleValidationResult(isValid, word2);
          gameState.chat.push(candidateText);
        } catch (error) {
          console.error('Error:', error);
          document.getElementById('error').textContent = "There was an error validating your word. Please try again.";
        }
      }
      // Function to handle validation result
      function handleValidationResult(isValid, word) {
        const error = document.getElementById('error');
        if (isValid) {
          if (gameState.chain.includes(word)) {
            error.textContent = 'Word already used!';
            gameState.invalidAttempts++;
            document.getElementById('wordInput').value = '';
            playInvalidSound();
            checkGameOver();
          } else {
            error.textContent = '';
            gameState.chain.push(word);
            gameState.currentWord = word;
            document.getElementById('wordInput').value = '';
            gameState.invalidAttempts = 0;
            updateDisplay();
            playCorrectSound();
            if (gameState.chain.length >= 2) {
              const lastTwoWords = gameState.chain.slice(-2);
              show3DAnimation(lastTwoWords[0], lastTwoWords[1]);
            }
            const milestone = gdata.milestoneIntervals.find(m => gameState.chain.length === m);
            if (milestone) {
              showMilestoneAlert(`Congratulations! You've reached a milestone of ${milestone} words!`);
              playMilestoneSound();
            } else {
              if (gameState.isFirstWord) {
                gameState.isFirstWord = false;
              }
              document.getElementById('timer').style.display = 'block';
              startTimer();
            }
            saveGame();
          }
        } else {
          if (/\d/.test(word)) {
            error.textContent = 'Numbers are not allowed!';
          } else if (['one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine', 'ten'].includes(word)) {
            error.textContent = 'Spelled-out numbers are not allowed!';
          } else {
            error.textContent = 'Not a valid phrase combination!';
          }
          gameState.invalidAttempts++;
          document.getElementById('wordInput').value = '';
          playInvalidSound();
          checkGameOver();
        }
        isSubmitting = false;
      }
      // Function to check if game is over
      function checkGameOver() {
        if (gameState.invalidAttempts >= gdata.maxInvalidAttempts) {
          clearInterval(timer);
          generateValidWord(gameState.currentWord).then(validWord => {
            playLoseSound();
            showAlert(`Game Over! Your final chain has ${gameState.chain.length} words. A valid word would have been: "${validWord}"`);
            saveGame();
          });
        }
      }
      // Function to generate a valid word using AI
      async function generateValidWord(currentWord) {
        const premise = `You are an AI that generates a valid and meaningful word that forms a two-word phrase with the given word. Only respond with a single word, nothing else. For the word "${currentWord}", generate a valid word that would form a meaningful two-word phrase. an example two word phrase would be car keys or show off or game show , you should understand your purpose`;
        try {
          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${localStorage.getItem('geminiApiKey')}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                contents: [{
                  parts: [{
                    text: premise
                  }]
                }]
              })
            }
          );
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          const data = await response.json();
          return data?.candidates?.[0]?.content?.parts?.[0]?.text.trim().toLowerCase() || 'unknown';
        } catch (error) {
          console.error('Error generating valid word:', error);
          return 'unknown';
        }
      }
      // Function to update the game display
      function updateDisplay() {
        document.getElementById('wordChain').textContent = gameState.chain.join(', ');
        document.getElementById('currentWord').textContent = `Current word: ${gameState.currentWord}`;
        document.getElementById('wordCount').textContent = gameState.chain.length;
        const nextMilestone = gdata.milestoneIntervals.find(m => m > gameState.chain.length) || 'Max';
        document.getElementById('milestone').textContent = `Next milestone: ${nextMilestone} words`;
        document.getElementById('timer').style.display = 'block';
        document.getElementById('highestScore').textContent = `Highest Score: ${gameState.highestScore}`;
      }
      // Function to show an alert
      function showAlert(message) {
        document.getElementById('alert-message').innerHTML = message;
        document.getElementById('alert-overlay').style.display = 'flex';
        const alertBox = document.getElementById('alert-box');
        alertBox.innerHTML = `
<p id="alert-message">${message}</p>
<button onclick="window.copyChainToClipboard()"><i class="fa fa-clipboard"></i> Copy Chain</button>
<button id="alert-close">OK</button>
`;
        document.getElementById('alert-close').onclick = function() {
          hideAlert();
          document.getElementById('gameplay-elements').style.display = 'none';
        };
      }
      // Function to copy the word chain to clipboard
      window.copyChainToClipboard = function() {
        const chainText = gameState.chain.join(', ');
        navigator.clipboard.writeText(chainText).then(() => {
          alert('Word chain copied to clipboard!');
        }).catch(err => {
          console.error('Failed to copy: ', err);
          alert('Failed to copy. Please try again.');
        });
      }
      // Function to hide the alert
      function hideAlert() {
        document.getElementById('alert-overlay').style.display = 'none';
      }
      // Function to play the milestone sound
      function playMilestoneSound() {
        const audio = document.getElementById('milestone-sound');
        if (audio.paused) {
          audio.play().catch(e => console.error("Error playing audio:", e));
        } else {
          audio.currentTime = 0;
        }
      }
      // Function to play the correct sound
      function playCorrectSound() {
        const audio = document.getElementById('correct-sound');
        if (audio.paused) {
          audio.play().catch(e => console.error("Error playing correct sound:", e));
        } else {
          audio.currentTime = 0;
        }
      }
      // Function to play the lose sound
      function playLoseSound() {
        const audio = document.getElementById('lose-sound');
        if (audio.paused) {
          audio.play().catch(e => console.error("Error playing lose sound:", e));
        } else {
          audio.currentTime = 0;
        }
      }
      // Function to play the invalid answer sound
      function playInvalidSound() {
        const audio = document.getElementById('invalid-sound');
        if (audio.paused) {
          audio.play().catch(e => console.error("Error playing invalid sound:", e));
        } else {
          audio.currentTime = 0;
        }
      }
      // Function to toggle the theme
      function toggleTheme(theme) {
        document.body.classList.toggle('light-mode', theme === 'light');
        localStorage.setItem('theme', theme);
        updateDropdownSelection('theme', theme);
        updateStarsColor(localStorage.getItem('mainColor') || gdata.defaultColor);
      }
      // Function to change the main color
      function changeMainColor(color) {
        document.documentElement.style.setProperty('--primary-color', color);
        document.body.setAttribute('data-main-color', color);
        localStorage.setItem('mainColor', color);
        updateStarsColor(color);
        updateDropdownSelection('color', color);
        updateGameContainerColor(color);
      }
      // Function to update game container color
      function updateGameContainerColor(color) {
        const gameContainer = document.getElementById('game-container');
        gameContainer.style.boxShadow = `0 0 10px ${color}`;
      }
      window.toggleTheme = toggleTheme;
      window.changeMainColor = changeMainColor;
      // Function to update the stars color
      function updateStarsColor(color) {
        const stars = document.querySelectorAll('.star');
        stars.forEach(star => {
          star.style.backgroundColor = color;
        });
      }
      // Function to toggle dropdown
      function toggleDropdown(dropdown) {
        const content = dropdown.querySelector('.dropdown-content');
        const isOpen = content.classList.contains('show');
        // Close all dropdowns
        document.querySelectorAll('.dropdown-content').forEach(dc => {
          dc.classList.remove('show');
          dc.style.maxHeight = '0px';
        });
        // Toggle the clicked dropdown
        if (!isOpen) {
          content.classList.add('show');
          content.style.maxHeight = content.scrollHeight + 'px';
        }
      }
      // Function to update dropdown selection
      function updateDropdownSelection(type, value) {
        const dropdowns = document.querySelectorAll('.dropdown');
        for (const dropdown of dropdowns) {
          const dropbtn = dropdown.querySelector('.dropbtn');
          if (type === 'theme' && dropbtn.textContent.includes('Theme')) {
            dropbtn.textContent = `Theme: ${value === 'dark' ? 'Dark Mode' : 'Light Mode'}`;
            break;
          } else if (type === 'color' && dropbtn.textContent.includes('Main Color')) {
            let colorName = 'Custom';
            if (value === '#ff3333') colorName = 'Red';
            else if (value === '#3333ff') colorName = 'Blue';
            else if (value === '#33ff33') colorName = 'Green';
            else if (value === '#ff33ff') colorName = 'Purple';
            dropbtn.textContent = `Main Color: ${colorName}`;
            break;
          }
        }
      }
      // Function to update volume
      function updateVolume(value) {
        const volumeValue = document.getElementById('volume-value');
        volumeValue.textContent = `${value}%`;
        volumeValue.style.fontWeight = 'bold';
        const backgroundMusic = document.getElementById('background-music');
        const milestoneSound = document.getElementById('milestone-sound');
        const correctSound = document.getElementById('correct-sound');
        const loseSound = document.getElementById('lose-sound');
        const invalidSound = document.getElementById('invalid-sound');
        const volume = value / 100;
        [backgroundMusic, milestoneSound, correctSound, loseSound, invalidSound].forEach(audio => {
          audio.volume = volume;
        });
        localStorage.setItem('volume', value);
        // Update the fill of the volume slider
        const volumeSlider = document.getElementById('volume-slider');
        volumeSlider.style.setProperty('--volume-percentage', `${value}%`);
      }
      // Function to fetch and display announcement
      function fetchAnnouncement() {
        fetch('https://iil.pages.dev/chained.txt')
          .then(response => response.text())
          .then(text => {
            const announcementBar = document.getElementById('announcement-bar');
            if (text.trim()) {
              announcementBar.textContent = text.trim();
              announcementBar.style.display = 'block';
              document.body.style.marginTop = announcementBar.offsetHeight + 'px';
              document.body.classList.add('has-announcement');
            }
          })
          .catch(error => console.error('Error fetching announcement:', error));
      }
      document.addEventListener('DOMContentLoaded', function() {
        // Initialize IndexedDB
        initDB();
        // Hide loading screen after 1 second
        setTimeout(hideLoadingScreen, 1000);
        // Fetch and display announcement
        fetchAnnouncement();
        document.getElementById('wordForm').addEventListener('submit', (e) => {
          e.preventDefault();
          submitWord();
        });
        document.getElementById('submitButton').addEventListener('click', submitWord);
        document.getElementById('wordInput').addEventListener('keyup', (e) => {
          if (e.key === 'Enter') {
            isSubmitting = false;
          }
        });
        document.getElementById('newGameButton').addEventListener('click', () => {
          clearInterval(timer);
          newGame();
          startTimer();
        });
        // Remove the event listener for alert-close as it's now handled in showAlert function
        const settingsButton = document.getElementById('settings-button');
        const settingsMenu = document.getElementById('settings-menu');
        const closeSettingsButton = document.getElementById('close-settings');
        const dropdowns = document.querySelectorAll('.dropdown');
        settingsButton.addEventListener('click', () => {
          settingsMenu.classList.add('open');
        });
        closeSettingsButton.addEventListener('click', () => {
          settingsMenu.classList.remove('open');
        });
        dropdowns.forEach(dropdown => {
          const dropbtn = dropdown.querySelector('.dropbtn');
          dropbtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleDropdown(dropdown);
          });
        });
        document.addEventListener('click', (event) => {
          if (!settingsMenu.contains(event.target) && event.target !== settingsButton) {
            settingsMenu.classList.remove('open');
          }
          dropdowns.forEach(dropdown => {
            if (!dropdown.contains(event.target)) {
              const content = dropdown.querySelector('.dropdown-content');
              content.classList.remove('show');
              content.style.maxHeight = '0px';
            }
          });
        });
        // Load saved settings
        const savedTheme = localStorage.getItem('theme') || gdata.defaultTheme;
        const savedColor = localStorage.getItem('mainColor') || gdata.defaultColor;
        const savedVolume = localStorage.getItem('volume') || 30;
        toggleTheme(savedTheme);
        changeMainColor(savedColor);
        updateVolume(savedVolume);

        function updateSelections() {
          updateDropdownSelection('theme', savedTheme);
          updateDropdownSelection('color', savedColor);
          updateStarsColor(savedColor);
          updateGameContainerColor(savedColor);
          document.body.setAttribute('data-main-color', savedColor);
          document.getElementById('volume-slider').value = savedVolume;
        }
        if (document.readyState === 'complete') {
          updateSelections();
        } else {
          window.addEventListener('load', updateSelections);
        }
        // Hide timer initially
        document.getElementById('timer').style.display = 'none';
        // Add event listener for volume control
        const volumeSlider = document.getElementById('volume-slider');
        volumeSlider.addEventListener('input', function() {
          updateVolume(this.value);
        });
        volumeSlider.addEventListener('change', function() {
          updateVolume(this.value);
        });
        // Check if Gemini API key is set
        if (!localStorage.getItem('geminiApiKey')) {
          showGeminiApiKeyPrompt();
        }
        // Add event listener for the Change API Key button
        document.getElementById('changeApiKeyButton').addEventListener('click', showGeminiApiKeyPrompt);
      });
      // Function to play background music
      function playBackgroundMusic() {
        const backgroundMusic = document.getElementById('background-music');
        const savedVolume = localStorage.getItem('volume') || 30;
        updateVolume(savedVolume);
        backgroundMusic.play().catch(e => console.error("Error playing background music:", e));
      }
      // Play background music when the page loads
            function onUserAction() {
    playBackgroundMusic();
    // Remove the event listener after the first action
    document.removeEventListener('click', onUserAction);
    document.removeEventListener('keydown', onUserAction);
}

// Attach the event listener to the document
document.addEventListener('click', onUserAction);  // Trigger on any mouse click
document.addEventListener('keydown', onUserAction);  // Or trigger on key press
      // Add event listeners for color change buttons
      document.querySelectorAll('.dropdown-content button').forEach(button => {
        button.addEventListener('click', function() {
          const action = this.textContent.toLowerCase();
          if (action === 'dark mode' || action === 'light mode') {
            toggleTheme(action === 'dark mode' ? 'dark' : 'light');
          } else {
            switch (action) {
              case 'red':
                changeMainColor('#ff3333');
                break;
              case 'blue':
                changeMainColor('#3333ff');
                break;
              case 'green':
                changeMainColor('#33ff33');
                break;
              case 'purple':
                changeMainColor('#ff33ff');
                break;
            }
          }
        });
      });
      // Function to show Gemini API key prompt
      function showGeminiApiKeyPrompt() {
        const promptOverlay = document.createElement('div');
        promptOverlay.style.position = 'fixed';
        promptOverlay.style.top = '0';
        promptOverlay.style.left = '0';
        promptOverlay.style.width = '100%';
        promptOverlay.style.height = '100%';
        promptOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
        promptOverlay.style.display = 'flex';
        promptOverlay.style.justifyContent = 'center';
        promptOverlay.style.alignItems = 'center';
        promptOverlay.style.zIndex = '9999';
        const promptBox = document.createElement('div');
        promptBox.style.backgroundColor = 'var(--secondary-color)';
        promptBox.style.padding = '20px';
        promptBox.style.borderRadius = '10px';
        promptBox.style.boxShadow = '0 0 10px rgba(0, 0, 0, 0.3)';
        promptBox.style.maxWidth = '400px';
        promptBox.style.width = '90%';
        promptBox.innerHTML = `
<h2 style="color: var(--text-color);">Enter Gemini API Key</h2>
<p style="color: var(--text-color);">Please enter your Gemini API key to use the game: you can get an API key for free at <a href='https://aistudio.google.com/apikey'>https://aistudio.google.com/apikey</a>.</p>
<input type="text" id="geminiApiKeyInput" style="width: 100%; padding: 5px; margin-bottom: 10px;">
<button id="submitGeminiApiKey" style="background-color: var(--primary-color); color: var(--text-color); border: none; padding: 10px; cursor: pointer;">Submit</button>
`;
        promptOverlay.appendChild(promptBox);
        document.body.appendChild(promptOverlay);
        document.getElementById('submitGeminiApiKey').addEventListener('click', function() {
          const apiKey = document.getElementById('geminiApiKeyInput').value.trim();
          if (apiKey) {
            localStorage.setItem('geminiApiKey', apiKey);
            document.body.removeChild(promptOverlay);
          } else {
            alert('Please enter a valid API key.');
          }
        });
      }
    })();
  </script>
  <script>
    (function() {
      // Function to hide loading screen
      function hideLoadingScreen() {
        const announcementBar = document.getElementById('announcement-bar');
        if (announcementBar.style.display === 'block') {
          document.body.style.marginTop = announcementBar.offsetHeight + 'px';
        }
        const loadingScreen = document.getElementById('loading-screen');
        loadingScreen.classList.add('fade-out');
        setTimeout(() => {
          loadingScreen.style.display = 'none';
        }, 1000);
      }
      const numStars = 200;
      const starsContainer = document.getElementById('stars-container');

      function createStar() {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = `${Math.random() * 100}%`;
        star.style.top = '-5%';
        star.style.animationDelay = `${Math.random() * 5}s`;
        star.style.width = `${Math.random() * 3 + 2}px`; // Random size between 2-5px
        star.style.height = star.style.width;
        starsContainer.appendChild(star);
        return star;
      }

      function moveStars() {
        const stars = starsContainer.children;
        for (let i = stars.length - 1; i >= 0; i--) {
          const star = stars[i];
          const currentTop = parseFloat(star.style.top);
          let newTop = currentTop + 0.1;
          if (newTop > 105) {
            starsContainer.removeChild(star);
            createStar();
          } else {
            star.style.top = `${newTop}%`;
          }
        }
        requestAnimationFrame(moveStars);
      }

      function initStars() {
        for (let i = 0; i < numStars; i++) {
          const star = createStar();
          star.style.top = `${Math.random() * 100}%`;
        }
      }
      // Function to fetch and display announcement
      function fetchAnnouncement() {
        fetch('https://iil.pages.dev/chained.txt')
          .then(response => response.text())
          .then(text => {
            const announcementBar = document.getElementById('announcement-bar');
            if (text.trim()) {
              announcementBar.textContent = text.trim();
              announcementBar.style.display = 'block';
              document.body.style.marginTop = announcementBar.offsetHeight + 'px';
              document.body.classList.add('has-announcement');
            }
          })
          .catch(error => console.error('Error fetching announcement:', error));
      }
      document.addEventListener('DOMContentLoaded', function() {
        // Hide loading screen after 1 second
        setTimeout(hideLoadingScreen, 1000);
        // Fetch and display announcement
        fetchAnnouncement();
        initStars();
        moveStars();
      });
    })();
  </script>
  <div id="chain-popup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: var(--secondary-color); padding: 20px; border-radius: 10px; z-index: 1000; max-width: 80%; max-height: 80%; overflow-y: auto; border: 2px solid var(--primary-color); box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);">
    <h3 id="chain-popup-title"></h3>
    <p id="chain-popup-content"></p>
    <button onclick="window.copyChain()"><i class="fa fa-clipboard"></i> Copy Chain</button>
    <button onclick="window.closeChainPopup()">Close</button>
  </div>
  <div id="rules-popup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: var(--secondary-color); padding: 20px; border-radius: 10px; z-index: 1000; max-width: 80%; max-height: 80%; overflow-y: auto; border: 2px solid var(--primary-color); box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);">
    <h3>Game Rules</h3>
    <p>Connect words to form valid two-word phrases.<br>
      Example: cell -&gt; phone -&gt; repair -&gt; guide -&gt; creator<br>
      Keep going as long as you can!<br>
      You can't use the same word twice in your chain.<br>
      Bug reports should be submitted through our Discord, not in the comments.<br>
      -- optional: please upvote.</p>
    <button onclick="window.closeRulesPopup()">Close</button>
  </div>
  <script>
    (function() {
      // Function to hide loading screen
      function hideLoadingScreen() {
        const announcementBar = document.getElementById('announcement-bar');
        if (announcementBar.style.display === 'block') {
          document.body.style.marginTop = announcementBar.offsetHeight + 'px';
        }
        const loadingScreen = document.getElementById('loading-screen');
        loadingScreen.classList.add('fade-out');
        setTimeout(() => {
          loadingScreen.style.display = 'none';
        }, 1000);
      }

      function showChainPopup(handle, wordCount, chain) {
        const popup = document.getElementById('chain-popup');
        const title = document.getElementById('chain-popup-title');
        const content = document.getElementById('chain-popup-content');
        title.textContent = `${handle}'s Chain (${wordCount} words)`;
        content.textContent = chain.replace(/ -> /g, ', ');
        popup.style.display = 'block';
      }

      function closeChainPopup() {
        document.getElementById('chain-popup').style.display = 'none';
      }

      function copyChain() {
        const chainText = document.getElementById('chain-popup-content').textContent;
        navigator.clipboard.writeText(chainText).then(() => {
          alert('Chain copied to clipboard!');
        }).catch(err => {
          console.error('Failed to copy: ', err);
          alert('Failed to copy. Please try again.');
        });
      }

      function showRulesPopup() {
        document.getElementById('rules-popup').style.display = 'block';
      }

      function closeRulesPopup() {
        document.getElementById('rules-popup').style.display = 'none';
      }
      window.showChainPopup = showChainPopup;
      window.closeChainPopup = closeChainPopup;
      window.copyChain = copyChain;
      window.showRulesPopup = showRulesPopup;
      window.closeRulesPopup = closeRulesPopup;
      // Show rules popup when the page loads
      document.addEventListener('DOMContentLoaded', function() {
        showRulesPopup();
        document.getElementById('showRulesButton').addEventListener('click', showRulesPopup);
      });
    })();
  </script>

</body>

</html>
